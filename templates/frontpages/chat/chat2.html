 
{%extends 'frontpages/layout.html'%}
{%load i18n%}
{%load core_template_tags%}
{% load admin_template_tags%}

{% block extrastyle %}
<!-- Theme JS files -->
<script src="/static/admin/global_assets/js/demo_pages/chat_layouts.js"></script>
<script src="/static/admin/global_assets/js/demo_pages/reconnecting-websocket.js"></script>
<!-- /theme JS files -->


{% endblock %}
{%block content%}
{% get_current_language as LANGUAGE_CODE %}

<style>
    .smaller_time{
        display: block;
        color: grey;
    }
</style>


		<!--Sliders Section-->
		<div>
			<div class="cover-image sptb-1 bg-background" data-image-src="/static/frontpages/images/banners/banner1.jpg">
				<div class="header-text1 mb-0">
					<div class="container">
						<div class="row">
							<div class="col-xl-8 col-lg-12 col-md-12 d-block mx-auto">
								<div class="text-center text-white ">
									<h2  class=""><span class="font-weight-bold" id =  "main-card-title"></span>  </h2>
								</div>
								
							</div>
						</div>
					</div>
				</div><!-- /header-text -->
			</div>
		</div>
		<!--/Sliders Section-->

		<!--Breadcrumb-->
		<div class="bg-white border-bottom">
			<div class="container">
				<div class="page-header">
					<h4 class="page-title">Chat List</h4>
					<ol class="breadcrumb">
						<li class="breadcrumb-item"><a href="/">Home</a></li>
						<li class="breadcrumb-item active"><a href="#">Chats</a></li>
						
					</ol>
				</div>
			</div>
		</div>
		<!--/Breadcrumb-->

		<!--Add listing-->
		
			<div class="container">
				<div class="row">
					<div class="col-xl-9 col-lg-9 col-md-12">
						<!--Add lists-->
						<div class=" mb-lg-0">
							<div class="">
								<div class="item2-gl business-list-01">
									
                                    <div class="content">

                                        <!-- Main chats -->
                                        <div class="card">
                        
                                            <div class="card-header header-elements-inline">
                                                <h5 id =  "main-card-title" class="card-title"></h5>
                                                <div class="header-elements">
                                                    <div class="list-icons">
                                                        <a class="list-icons-item" data-action="collapse"></a>
                                                        <a class="list-icons-item" data-action="reload"></a>
                                                        <a class="list-icons-item" data-action="remove"></a>
                                                    </div>
                                                </div>
                                            </div>
                        
                        
                                            <div class="card-body">
                                                <ul id = "main-chat-ul" class="media-list media-chat media-chat-scrollable mb-3">
                                    
                                                    
                        
                                                </ul>
                        
                                                <textarea id =  "chat-message-input" name="enter-message" class="form-control mb-3" rows="3" cols="1" placeholder="message..."></textarea>
                        
                                                <div class="d-flex align-items-center">
                                                    <!-- <div class="list-icons list-icons-extended">
                                                        <a href="#" class="list-icons-item" data-popup="tooltip" data-container="body" title="Send photo"><i class="icon-file-picture"></i></a>
                                                        <a href="#" class="list-icons-item" data-popup="tooltip" data-container="body" title="Send video"><i class="icon-file-video"></i></a>
                                                        <a href="#" class="list-icons-item" data-popup="tooltip" data-container="body" title="Send file"><i class="icon-file-plus"></i></a>
                                                    </div> -->
                        
                                                    <button type="button"  id = "chat-message-submit" class="btn bg-teal-400 btn-labeled btn-labeled-right ml-auto"><b><i class="icon-paperplane"></i></b> Send</button>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- /line content divider -->
                        
                        
                        
                                        <!-- Line of other chats -->
                                        <div class="card">
                                            <div class="card-header header-elements-inline">
                                                <h5 class="card-title">Line Other Chats</h5>
                                                <div class="header-elements">
                                                    <div class="list-icons">
                                                        <a class="list-icons-item" data-action="collapse"></a>
                                                        <a class="list-icons-item" data-action="reload"></a>
                                                        <a class="list-icons-item" data-action="remove"></a>
                                                    </div>
                                                </div>
                                            </div>
                        
                                            <div class="card-body">
                                                {% recieved_grouped_messages user 5 name as recieved_grouped_messages %}
                                                <ul class="media-list media-chat-scrollable mb-3">
                                                    {% for message_obj in recieved_grouped_messages %} 
                                                
                                                        <!-- <li class="media content-divider justify-content-center text-muted mx-0">
                                                            <span class="px-2">Saturday, Feb 12</span>
                                                        </li> -->
                        
                                                        <li class="media">
                                                            <div class="mr-3"><a href="{{message_obj.sender_image}}"><img src="{{message_obj.sender_image}}" class="rounded-circle" width="40" height="40" alt=""></a></div>
                                                            <div class="media-body">
                                                                <div class="media-title d-flex flex-nowrap">
                                                                    <a href="/chat/{{message_obj.chat_group}}/" class="font-weight-semibold mr-3">{{message_obj.sender_name}}</a>
                                                                    <span class="font-size-sm text-muted text-nowrap ml-auto">{{message_obj.time}} <a href="#"><i class="icon-pin-alt font-size-base text-muted ml-2"></i></a></span>
                                                                </div>
                                                                {{message_obj.content}}
                                                            </div>
                                                        </li>
                                                    {% endfor %}
                                            
                                                    
                                            
                                            </div>

                                        </div>
                                        <!-- /line content divider -->

                                        
                                    </div>
                                     
                                    <input type = "hidden" id = "username" value = "{{user.username}}">
                                    <!-- ####################################################################################### -->

                                    {{ name|json_script:"g_name" }}



								</div>
								
							</div>
						</div>
						<!--/Add lists-->
					</div>

					<!--Right Side Content-->
					
					<div class="col-xl-3 col-lg-3 col-md-12">
						<form action = "/collaborations/customer_news_list/" method = "GET" >
					
						<div class="card">
							<div class="card-body">
								<div class="input-group">
										<input type="text" id = "by_title" name = "by_title" class="form-control br-tl-3 br-bl-3" placeholder="Search">
										<div class="input-group-append ">
											<button type="submit" class="btn btn-secondary br-tr-3 br-br-3">
												Search
											</button>
										</div>
								</div>
							</div>
						</div>
						</form>


						<form action = "/collaborations/customer_news_list/" method = "GET">
						<div class="card mb-0">
							<div class="card-header">
								<h3 class="card-title">Campanies</h3>
							</div>
							<div class="card-body">
								<div class="" id="container">
									<div class="filter-product-checkboxs">
										
										<label class="custom-control custom-checkbox mb-3">
											<input type="checkbox" class="custom-control-input" name="by_category"   value="{{category.0}}">
											<span class="custom-control-label">
												<a  class="text-dark"></a>
											</span>
										</label>
									
										
									</div>
								</div>
							</div>
					
							<div class="card-footer">
								<button type = "submit" value="Something" href="#" class="btn btn-primary btn-block">Apply Filter</a>
							</div>
						</div>
						</form>
					</div>
					<!--/Right Side Content-->
				</div>
			</div>
		</section>
		<!--/Add Listings-->

        <script src="/static/admin/global_assets/js/demo_pages/reconnecting-websocket.js"></script>
        <script src="/static/admin/global_assets/js/plugins/pickers/daterangepicker.js"></script>
	    <script src="/static/admin/global_assets/js/plugins/ui/perfect_scrollbar.min.js"></script> 

        <script >
  
            const group_name = JSON.parse(document.getElementById('g_name').textContent);
            // const username = JSON.parse(document.getElementById("username").value);
            var username = document.getElementById("username").value
            const chatSocket = new ReconnectingWebSocket(
                'ws://'
                + window.location.host
                + '/ws/chat/'
                + group_name
                + '/'
            );
            
            chatSocket.onopen = function(e){
                console.log("on open called!", group_name)
                    document.getElementById("chat-message-input").disabled = false;
                    document.getElementById("chat-message-input").value = "";
                    document.getElementById("chat-message-submit").disabled = false;
                    chatSocket.send(JSON.stringify({
                        'command':'fetch_messages',
                    }));
            }

            chatSocket.onmessage = function(e) { 
                const data = JSON.parse(e.data);
                var messages = data['message']

                for (i in messages){
                    if (messages[i].sender_name != username){
                      document.getElementById("main-card-title").innerHTML = "Your latest chats"
                        break;
                    }
                }
                messages.forEach(append_message);
            };
         
            chatSocket.onclose = function(e) {
                var el = document.createElement('div');
                    document.getElementById("chat-message-input").value = "Connection Lost, Cannot write message!"
                    document.getElementById("chat-message-input").disabled = true;
                    document.getElementById("chat-message-submit").disabled = true;

                    // el.setAttribute("style", "padding:1%; width: 30%; height:5%; position:absolute; font-size:13px; top:40%; left:40%; background-color: rgb(228, 228, 228); color:black;");
                    // el.innerHTML = "Lost connection with FBPIDI system! \n Trying to Reconnect...";
                    // document.body.appendChild(el);
 
                    // setTimeout( function(){ el.parentNode.removeChild(el);}, 5000);
                    console.log('Chat socket closed unexpectedly, from room.html');
                    
                };

            var css = 'h1 { color: white; }',
                head = document.head || document.getElementsByTagName('head')[0],
                style = document.createElement('style');

            head.appendChild(style);

            style.type = 'text/css';
            if (style.styleSheet){
            // This is required for IE8 and below.
            style.styleSheet.cssText = css;
            } else {
            style.appendChild(document.createTextNode(css));
            }

            function  scroll_down()
                    {
                        var main_ul = document.getElementById("main-chat-ul");
                        main_ul.scrollTop = main_ul.scrollHeight;
                    }
  
            function append_message(message_obj)
            {
                checked_days = new Array();
                // if ( ! message_obj.timestamp in checked_days){


                // }
                var br = document.createElement('br')
                var li_item = document.createElement('li');
                    var img_div = document.createElement('div');
                        var image_anchor = document.createElement('a');
                            var image_item = document.createElement('img');

                    var chat_div = document.createElement('div');
                        var chat_area = document.createElement('p');
                        var time_area = document.createElement('small');

                // common for bothe sender and reciever
                image_anchor.href = message_obj.sender_image;
                image_item.src = message_obj.sender_image;
                image_item.className = "rounded-circle"
                image_item.width = "60";
                image_item.height = "60";
               

                chat_div.className = "media-body"
                    chat_area.textContent = message_obj.content;
                    chat_area.className = "media-chat-item";
                    time_area.textContent = message_obj.time;
                    time_area.className = "smaller_time";

                    
                //  if message is from another user
                if (message_obj.sender_name != username)
                {  
                    li_item.className = "media";
                    img_div.className = "mr-3";

                    image_anchor.appendChild(image_item);
                    img_div.appendChild(image_anchor);

                    chat_div.appendChild(chat_area);
                    chat_div.appendChild(time_area);

                    li_item.appendChild(img_div);
                    li_item.appendChild(chat_div);
                    

                    document.querySelector('#main-chat-ul').appendChild(li_item);
                    scroll_down();

                }

                else{
                    li_item.className = "media media-chat-item-reverse";
                    img_div.className = "ml-3";

                    chat_div.appendChild(chat_area);
                    chat_div.appendChild(time_area);

                    image_anchor.appendChild(image_item);
                    img_div.appendChild(image_anchor);

                    chat_div.appendChild(chat_area);
                    chat_div.appendChild(time_area); 
                    
                    li_item.appendChild(chat_div);
                    li_item.appendChild(img_div);
                   
              
                    document.querySelector('#main-chat-ul').appendChild(li_item);
                    scroll_down();
                }

               
                

                
            }
        
            document.querySelector('#chat-message-input').focus();
            document.querySelector('#chat-message-input').onkeyup = function(e) {
                if (e.keyCode === 13) {  // enter, return
                    document.querySelector('#chat-message-submit').click();
                }
            };
        
            document.querySelector('#chat-message-submit').onclick = function(e) {
                const messageInputDom = document.querySelector('#chat-message-input');
                const message = messageInputDom.value;
               if (message == "" || message == null){
                   window.alert("No message to Send!");
               }
               else{
                            chatSocket.send(JSON.stringify({
                            'message': message,
                            'command':'new_message',
                            'from':username
                        }));
                        messageInputDom.value = '';
                    }
                
                
              
            };
        </script>
		
	

		<!--<section class="sptb">-->
			
			
		{%endblock%}

	
		



		